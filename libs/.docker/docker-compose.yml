name: superagent
services:
  superagent-api:
    networks:
      - shared_network
    build:
      context: ../superagent
      dockerfile: Dockerfile
    command: /bin/sh -c "until nc -z ${POSTGRES_DB_HOST} 5432; do echo 'waiting for ${POSTGRES_DB_HOST}:5432 to be available'; sleep 1; done && prisma migrate deploy && exec gunicorn --bind :8080 --workers 2 --timeout 0 --worker-class uvicorn.workers.UvicornWorker --threads 8 app.main:app"
    environment:
      - PORT=8080
      - SUPERAGENT_API_URL=${SUPERAGENT_API_URL}
      - SUPERRAG_API_URL=${SUPERRAG_API_URL}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - POSTGRES_DB_HOST=${POSTGRES_DB_HOST}
      - POSTGRES_DB_PORT=${POSTGRES_DB_PORT}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_MIGRATION_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - DATABASE_SHADOW_URL=${DATABASE_SHADOW_URL}
      - MEMORY=${MEMORY}
      - MEMORY_API_URL=${MEMORY_API_URL}
      - REDIS_MEMORY_URL=${REDIS_MEMORY_URL}
      - REDIS_MEMORY_WINDOW=${REDIS_MEMORY_WINDOW}
      - VECTORSTORE=${VECTORSTORE}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - QDRANT_HOST=${QDRANT_HOST}
      - QDRANT_INDEX=${QDRANT_INDEX}
      - WEAVIATE_API_KEY=${WEAVIATE_API_KEY}
      - WEAVIATE_INDEX=${WEAVIATE_INDEX}
      - WEAVIATE_URL=${WEAVIATE_URL}
      - PINECONE_ENVIRONMENT=${PINECONE_ENVIRONMENT}
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - PINECONE_INDEX=${PINECONE_INDEX}
      - ASTRA_DB_ID=${ASTRA_DB_ID}
      - ASTRA_DB_REGION=${ASTRA_DB_REGION}
      - ASTRA_DB_APPLICATION_TOKEN=${ASTRA_DB_APPLICATION_TOKEN}
      - COLLECTION_NAME=${COLLECTION_NAME}
      - KEYSPACE_NAME=${KEYSPACE_NAME}
      - E2B_API_KEY=${E2B_API_KEY}
      - REPLICATE_API_TOKEN=${REPLICATE_API_TOKEN}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY}
      - LANGFUSE_HOST=${LANGFUSE_HOST}
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2}
      - LANGCHAIN_ENDPOINT=${LANGCHAIN_ENDPOINT}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}
      - LANGSMITH_PROJECT_ID=${LANGSMITH_PROJECT_ID}
      - LAMINI_API_KEY=${LAMINI_API_KEY}
      - SEGMENT_WRITE_KEY=${SEGMENT_WRITE_KEY}
      - AGENTOPS_API_KEY=${AGENTOPS_API_KEY}
      - AGENTOPS_ORG_KEY=${AGENTOPS_ORG_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT=${AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT}
    ports:
      - 8081:8080
    restart: unless-stopped

networks:
  shared_network:
    external: true
  superagent_network:
    name: superagent_network
    driver: bridge
